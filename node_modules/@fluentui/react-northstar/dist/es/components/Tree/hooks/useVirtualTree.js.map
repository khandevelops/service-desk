{"version":3,"file":"useVirtualTree.js","names":["React","useTree","useVirtualTree","props","baseTree","baseRegisterItemRef","registerItemRef","baseExpandSiblings","expandSiblings","getItemById","getItemRef","visibleItemIds","listRef","useRef","focusIdRef","focusItemById","useCallback","id","itemRef","current","focusIndex","indexOf","scrollToItem","hasSubtree","focus","firstElementChild","node","e","useLayoutEffect","searchByFirstChar","startIndex","endIndex","char","itemToString","item","content","i","itemFirstChar","trim","charAt","toLowerCase","getToFocusIDByFirstCharacter","idToStartSearch","starIndex","length","toFocusIndex","key"],"sources":["components/Tree/hooks/useVirtualTree.ts"],"sourcesContent":["import * as React from 'react';\nimport { useTree, UseTreeResult, UseTreeOptions } from './useTree';\nimport { ShorthandValue } from '../../../types';\nimport { TreeItemProps } from '../TreeItem';\n\nexport interface UseVirtualTreeOptions extends Omit<UseTreeOptions, 'selectedItemIds' | 'defaultSelectedItemIds'> {\n  /**\n   * A function that converts an item to string. Used for keyboard navigation based on the first letter of an item's text content\n   */\n  itemToString?: (item: ShorthandValue<TreeItemProps>) => string;\n}\n\nexport interface UseVirtualTreeResult extends UseTreeResult {\n  /** ref to be assigned to react-window VariableSizeList/FixedSizeList component */\n  listRef: React.MutableRefObject<any>;\n}\n\n// export our own interface that is similar to react-window VariableSizeList,\n//  to avoid dependency to react-window\nexport interface VariableSizeListRef extends React.Component<any> {\n  scrollTo(scrollOffset: number): void;\n  scrollToItem(index: number, align?: 'auto' | 'smart' | 'center' | 'end' | 'start'): void;\n\n  resetAfterIndex(index: number, shouldForceUpdate?: boolean): void;\n}\n\nexport function useVirtualTree(props: UseVirtualTreeOptions): UseVirtualTreeResult {\n  const baseTree = useTree(props);\n  const {\n    registerItemRef: baseRegisterItemRef,\n    expandSiblings: baseExpandSiblings,\n    getItemById,\n    getItemRef,\n    visibleItemIds,\n  } = baseTree;\n\n  const listRef = React.useRef<VariableSizeListRef>();\n  const focusIdRef = React.useRef<string>();\n\n  const focusItemById = React.useCallback(\n    (id: string) => {\n      const itemRef = getItemRef(id);\n\n      // item is not mounted yet\n      if (itemRef == null) {\n        // set focusIdRef so item can be focused on mount; then scroll to item\n        focusIdRef.current = id;\n        const focusIndex = visibleItemIds.indexOf(focusIdRef.current);\n        if (focusIndex >= 0) {\n          listRef.current?.scrollToItem(focusIndex, 'center');\n        }\n        return;\n      }\n\n      // item is mounted, set focus\n      if (getItemById(id)?.hasSubtree) {\n        itemRef.focus();\n      } else {\n        // when tree item is leaf, need to focus on the inner treeTitle\n        (itemRef.firstElementChild as HTMLElement)?.focus();\n      }\n    },\n    [getItemById, getItemRef, visibleItemIds],\n  );\n\n  const registerItemRef = React.useCallback(\n    (id: string, node: HTMLElement) => {\n      baseRegisterItemRef(id, node);\n      if (node && focusIdRef.current === id) {\n        // focus on this tree item\n        if (getItemById(id)?.hasSubtree) {\n          node.focus();\n        } else {\n          // when node is leaf, need to focus on the inner treeTitle\n          (node.firstElementChild as HTMLElement)?.focus();\n        }\n        focusIdRef.current = null;\n      }\n    },\n    [baseRegisterItemRef, getItemById],\n  );\n\n  const expandSiblings = React.useCallback(\n    (e: React.KeyboardEvent, id: string) => {\n      baseExpandSiblings(e, id);\n      focusIdRef.current = id;\n    },\n    [baseExpandSiblings],\n  );\n\n  React.useLayoutEffect(() => {\n    /**\n     * Reason for scroll in useLayoutEffect:\n     * Without useLayoutEffect, scrolling works for focus parent and focus first child, but it is problematic for expanding sibings.\n     * When focus parent/child, the number of items (itemCount) in the virtual list does not change. But when sibling expand, itemCount could change.\n     * When siblings are expanded:\n     *  without useLayoutEffect, react window uses the itemCount before siblings are expanded, causing it to compute wrong scroll offset.\n     *  with useLayoutEffect, the scrolling happens after the new itemCount passed into list as props. Therefore the computed scroll offset is correct.\n     */\n    if (focusIdRef.current != null && getItemRef(focusIdRef.current) == null) {\n      const focusIndex = visibleItemIds.indexOf(focusIdRef.current);\n      if (focusIndex >= 0) {\n        listRef.current?.scrollToItem(focusIndex, 'center');\n      }\n    }\n  }, [getItemRef, visibleItemIds]);\n\n  const searchByFirstChar = React.useCallback(\n    (startIndex: number, endIndex: number, char: string) => {\n      const itemToString = props.itemToString || (item => (item as any).content || '');\n      for (let i = startIndex; i < endIndex; ++i) {\n        const itemFirstChar = itemToString(getItemById(visibleItemIds[i]).item)?.trim()?.charAt(0)?.toLowerCase();\n        if (itemFirstChar === char.toLowerCase()) {\n          return i;\n        }\n      }\n      return -1;\n    },\n    [getItemById, props.itemToString, visibleItemIds],\n  );\n\n  const getToFocusIDByFirstCharacter = React.useCallback(\n    (e: React.KeyboardEvent, idToStartSearch: string) => {\n      // Get start index for search\n      let starIndex = visibleItemIds.indexOf(idToStartSearch) + 1;\n      if (starIndex === visibleItemIds.length) {\n        starIndex = 0;\n      }\n\n      // Check following nodes in tree\n      let toFocusIndex = searchByFirstChar(starIndex, visibleItemIds.length, e.key);\n      // If not found in following nodes, check from beginning\n      if (toFocusIndex === -1) {\n        toFocusIndex = searchByFirstChar(0, starIndex - 1, e.key);\n      }\n\n      if (toFocusIndex === -1) {\n        return idToStartSearch;\n      }\n\n      return visibleItemIds[toFocusIndex];\n    },\n    [searchByFirstChar, visibleItemIds],\n  );\n\n  return {\n    ...baseTree,\n    registerItemRef,\n    focusItemById,\n    expandSiblings,\n    getToFocusIDByFirstCharacter,\n    listRef,\n  };\n}\n"],"mappings":"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"}