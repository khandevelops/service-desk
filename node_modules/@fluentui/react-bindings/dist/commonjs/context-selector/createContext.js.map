{"version":3,"file":"createContext.js","names":["React","_interopRequireWildcard","require","_utils","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","createProvider","Original","Provider","props","valueRef","useRef","value","versionRef","contextValue","current","version","listeners","useIsomorphicLayoutEffect","runWithNormalPriority","forEach","listener","createElement","children","process","env","NODE_ENV","displayName","createContext","defaultValue","context","Consumer","exports"],"sources":["context-selector/createContext.ts"],"sourcesContent":["import * as React from 'react';\n\nimport { Context, ContextValue } from './types';\nimport { runWithNormalPriority, useIsomorphicLayoutEffect } from './utils';\n\nconst createProvider = <Value>(Original: React.Provider<ContextValue<Value>>) => {\n  const Provider: React.FC<React.ProviderProps<Value>> = props => {\n    // Holds an actual \"props.value\"\n    const valueRef = React.useRef(props.value);\n    // Used to sync context updates and avoid stale values, can be considered as render/effect counter of Provider.\n    const versionRef = React.useRef(0);\n\n    // A stable object, is used to avoid context updates via mutation of its values.\n    const contextValue = React.useRef<ContextValue<Value>>();\n\n    if (!contextValue.current) {\n      contextValue.current = {\n        value: valueRef,\n        version: versionRef,\n        listeners: [],\n      };\n    }\n\n    useIsomorphicLayoutEffect(() => {\n      valueRef.current = props.value;\n      versionRef.current += 1;\n\n      runWithNormalPriority(() => {\n        (contextValue.current as ContextValue<Value>).listeners.forEach(listener => {\n          listener([versionRef.current, props.value]);\n        });\n      });\n    }, [props.value]);\n\n    return React.createElement(Original, { value: contextValue.current }, props.children);\n  };\n\n  /* istanbul ignore else */\n  if (process.env.NODE_ENV !== 'production') {\n    Provider.displayName = 'ContextSelector.Provider';\n  }\n\n  return Provider;\n};\n\nexport const createContext = <Value>(defaultValue: Value): Context<Value> => {\n  const context = React.createContext<ContextValue<Value>>({\n    value: { current: defaultValue },\n    version: { current: -1 },\n    listeners: [],\n  });\n\n  context.Provider = createProvider<Value>(context.Provider) as any;\n\n  // We don't support Consumer API\n  delete (context as unknown as Context<Value>).Consumer;\n\n  return context as unknown as Context<Value>;\n};\n"],"mappings":"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"}