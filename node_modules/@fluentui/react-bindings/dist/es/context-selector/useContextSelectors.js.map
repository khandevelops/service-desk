{"version":3,"file":"useContextSelectors.js","names":["React","useIsomorphicLayoutEffect","useContextSelectors","context","selectors","contextValue","useContext","value","current","version","listeners","selected","Object","keys","forEach","key","_React$useReducer","useReducer","prevState","payload","stateHasNotChanged","every","is","statePayloadHasChanged","some","nextSelected","selectedHasNotChanged","e","concat","state","dispatch","hasSelectedValuesUpdates","find","undefined","push","index","indexOf","splice"],"sources":["context-selector/useContextSelectors.ts"],"sourcesContent":["import * as React from 'react';\nimport { Context, ContextSelector, ContextVersion, ContextValues } from './types';\nimport { useIsomorphicLayoutEffect } from './utils';\n\n/**\n * This hook returns context selected value by selectors.\n * It will only accept context created by `createContext`.\n * It will trigger re-render if only the selected value is referencially changed.\n */\nexport const useContextSelectors = <\n  Value extends Record<string, any>,\n  Properties extends string,\n  Selectors extends Record<Properties, ContextSelector<Value, SelectedValue>>,\n  SelectedValue extends any,\n>(\n  context: Context<Value>,\n  selectors: Selectors,\n): Record<Properties, SelectedValue> => {\n  const contextValue = React.useContext(context as unknown as Context<ContextValues<Value>>);\n\n  const {\n    value: { current: value },\n    version: { current: version },\n    listeners,\n  } = contextValue;\n\n  const selected = {} as Record<Properties, SelectedValue>;\n  Object.keys(selectors).forEach((key: Properties) => {\n    selected[key] = selectors[key](value);\n  });\n\n  const [state, dispatch] = React.useReducer(\n    (\n      prevState: readonly [\n        Value /* contextValue */,\n        Record<Properties, SelectedValue> /* { [key]: selector(value) } */,\n      ],\n      payload:\n        | undefined // undefined from render below\n        | readonly [ContextVersion, Value], // from provider effect\n    ) => {\n      if (!payload) {\n        // early bail out when is dispatched during render\n        return [value, selected] as const;\n      }\n\n      if (payload[0] <= version) {\n        const stateHasNotChanged = Object.keys(selectors).every((key: Properties) =>\n          Object.is((prevState[1] as { [key: string]: any })[key] as SelectedValue, selected[key]),\n        );\n\n        if (stateHasNotChanged) {\n          return prevState; // bail out\n        }\n\n        return [value, selected] as const;\n      }\n\n      try {\n        const statePayloadHasChanged = Object.keys(prevState[0]).some((key: Properties) => {\n          return !Object.is(prevState[0] /* previous contextValue */[key], payload[1] /* current contextValue */[key]);\n        });\n\n        if (!statePayloadHasChanged) {\n          return prevState;\n        }\n\n        const nextSelected = {} as Record<Properties, SelectedValue>;\n        Object.keys(selectors).forEach((key: Properties) => {\n          nextSelected[key] = selectors[key](payload[1]);\n        });\n\n        const selectedHasNotChanged = Object.keys(selectors).every((key: Properties) => {\n          return Object.is(prevState[1][key] /* previous { [key]: selector(value) } */, nextSelected[key]);\n        });\n\n        if (selectedHasNotChanged) {\n          return prevState;\n        }\n\n        return [payload[1], nextSelected] as const;\n      } catch (e) {\n        // ignored (stale props or some other reason)\n      }\n      return [...prevState] as const; // schedule update\n    },\n    [value, selected] as const,\n  );\n\n  // schedule re-render when selected context is updated\n  const hasSelectedValuesUpdates = Object.keys(selectors).find(\n    (key: Properties) => !Object.is(state[1] /* previous { [key]: selector(value) } */[key], selected[key]),\n  );\n  if (hasSelectedValuesUpdates !== undefined) {\n    dispatch(undefined);\n  }\n\n  useIsomorphicLayoutEffect(() => {\n    listeners.push(dispatch);\n\n    return () => {\n      const index = listeners.indexOf(dispatch);\n      listeners.splice(index, 1);\n    };\n  }, [listeners]);\n\n  return state[1] as Record<Properties, SelectedValue>;\n};\n"],"mappings":"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"}